<!doctype html>
<html>
 <head>
  <title>Techlahoma user group events</title>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
  <link rel='stylesheet' type='text/css' href='css/fullcalendar.css' />
  <link rel='stylesheet' type='text/css' href='css/override.css' />
 </head>
 <body>
 <div class="container" style="margin-top:20px;">

  <div style="border-bottom: 1px solid #ccc; margin-bottom: 15px;">
   <h1>
     Techlahoma user group events
   </h1>
  </div>



  <div style="width: 100%;">
    <div class="pull-left" style="width: 25%;">
      <table class="table" id="groups-table" style="display:none;">
       <thead>
        <tr><th>Group  <th># Events <th>
       </thead>
       <tbody></tbody>
      </table>

      <br>
      <table id="calendars-table" class="table" style="margin-top: 10px;">
       <tbody></tbody>
      </table>
      <div>
      </div>

    </div>

    <div class="pull-right" style="width: 75%;">

      <ul class="nav nav-pills pull-left">
        <li id="events-calendar-link" class="events-link active"><a href="javascript:changeView('calendar')">Calendar View</a>
        <li id="events-table-link" class="events-link"><a href="javascript:changeView('table')">Table View</a>
        <li id="events-list-link" class="events-link"><a href="javascript:changeView('list')">List View</a>
      </ul>

      <div id="events-calendar" class="events-view" style=""></div>

      <table id="events-table" class="table events-view"  style="display:none;">
       <thead>
        <tr><th>Date/Time   <th>Event   <th>Group
       </thead>
       <tbody></tbody>
      </table>

      <ul id="events-list" class="events-view" style="display:none;clear:left;">

      </ul>

    </div>
  </div>


 </div>

 <script src="js/moment.min.js"></script>
 <script src="js/jquery.min.js"></script>
 <script src='js/fullcalendar.js'></script>
 <script src='js/gcal.js'></script>
 <script src="data/usergroups.js"></script>
<script type="text/javascript">
var MG = {};
MG.groups = [];
MG.groupedEvents = {};

function changeView(viewId) {
  $('.events-view').hide();
  $('#events-' + viewId).show();

  $('.events-link').removeClass('active');
  $('#events-' + viewId + '-link').addClass('active');
}

function getGroups() {
  var groups = JSON.parse(usergroups);

  var groupNames = groups
  .filter(function(group) {
    return group["nameInMeetupURL"].length > 0;
  })
  .map(function(group){
    return group["nameInMeetupURL"];
  });

  return groupNames;
}

function renderEvents() {
  $('#events-list').empty();
  $('#events-table tbody').empty();

  var allEvents = [];
  $.each(MG.groupedEvents, function(groupId, events) {
    allEvents = allEvents.concat(MG.groupedEvents[groupId]);
  });

  // Sort events by time
  allEvents.sort(function(a, b) {
    return a.time - b.time;
  });

  // Add to table

  $.each(allEvents, function(index, event) {

    var dateTime = moment(event.time).format('ddd, MMM Do, h:mma');
    var eventStr = '<a href="' + event.event_url + '">' + event.name + '</a>';
    var groupId  = event.group.urlname;
    var groupStr = '<a href="http://meetup.com/' + groupId + '">' + groupId + '</a>';
    // add to table
    var $eventRow = $('<tr><td>' + dateTime + '<td>' + eventStr + '<td>' + groupStr);
    $eventRow.addClass('group-' + groupId);
    $('#events-table tbody').append($eventRow);

    var $eventItem = $('<li></li>');
    $eventItem.append(dateTime + ': ' + eventStr + ' (' + groupStr + ')');
    $('#events-list').append($eventItem);
  });

  $('#events-calendar').fullCalendar('refetchEvents');
}

function renderGroups() {
  $('#groups-table tbody').empty();

  var allGroups = [];
  $.each(MG.groupedEvents, function(groupId, events) {
    allGroups.push(groupId);
  });

  // Sort alphabetically
  allGroups.sort();

  $.each(allGroups, function(index, groupId) {
    var groupStr = '<a href="http://meetup.com/' + groupId + '">' + groupId + '</a>';
    var $groupRow = $('<tr>').addClass('group-' + groupId);
    $groupRow.append('<td>' + groupStr);
    var badgeClass = (MG.groupedEvents[groupId].length > 0) ? 'badge badge-success' : 'badge';
    $groupRow.append('<td><span class="' + badgeClass + '">' + MG.groupedEvents[groupId].length + '</span>');
    $('#groups-table tbody').append($groupRow);
  });

  if (allGroups.length > 0) {
    $('#groups-table').show();
  }
}

function getGroupEvents(groupId) {
  var meetupParams = {'group_urlname': groupId};
  var meetupUrl = 'https://api.meetup.com/2/events.json?' + $.param(meetupParams);
  var proxyUrl = 'https://crossorigin.me/' + meetupUrl;

  $.getJSON(proxyUrl, function(data){
    if(data){
      MG.groupedEvents[groupId] = data.results;
      renderGroups();
      renderEvents();
    }
  });
}

function refreshGroups() {
  // For anything in hash we dont have events for, fetch them
  var groups = getGroups();

  $.each(groups, function(index, groupId) {
    if (!(groupId in MG.groupedEvents)) {
      getGroupEvents(groupId);
    }
  });
}

$(document).ready(function(){

  $('#events-calendar').fullCalendar({
    editable: false,
    aspectRatio: 2,
    header: {
        left: 'prev,next',
        center: 'title',
        right: 'month,basicWeek,basicDay'
    },
    events: function(start, end, timezone, callback) {
      var allEvents = [];
      $.each(MG.groupedEvents, function(groupId, events) {
        $.each(events, function(index, event) {
          allEvents.push(
            {
              title: event.group.name, 
              start: new Date(event.time), 
              url: event.event_url, 
              color: '#C92525'
            });
        });
      });
      callback(allEvents);
    }
  });

  refreshGroups();

  $('#events-calendar').fullCalendar('refetchEvents');
});

</script>
</body>
</html>
