<!doctype html>
<html>
 <head>
  <title>Techlahoma user group events</title>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
  <link rel='stylesheet' type='text/css' href='css/fullcalendar.css' />
  <link rel='stylesheet' type='text/css' href='css/override.css' />
 </head>
 <body>
 <div class="container" style="margin-top:20px;">

  <div style="border-bottom: 1px solid #ccc; margin-bottom: 15px;">
   <h1>
     Techlahoma user group events
   </h1>
  </div>

  <div style="width: 100%;">
    <div class="pull-left" style="width: 25%;">
      <table class="table" id="groups-table" style="display:none;">
       <thead>
        <tr><th>Group  <th># Events <th>
       </thead>
       <tbody></tbody>
      </table>
    </div>

    <div class="pull-right" style="width: 75%;">

      <ul class="nav nav-pills pull-left">
        <li id="events-calendar-link" class="events-link active"><a href="javascript:changeView('calendar')">Calendar View</a>
        <li id="events-table-link" class="events-link"><a href="javascript:changeView('table')">Table View</a>
        <li id="events-list-link" class="events-link"><a href="javascript:changeView('list')">List View</a>
      </ul>

      <div id="events-calendar" class="events-view" style=""></div>

      <table id="events-table" class="table events-view"  style="display:none;">
       <thead>
        <tr><th width="30%">Date/Time<th>Event<th width="30%">Group
       </thead>
       <tbody></tbody>
      </table>

      <ul id="events-list" class="events-view" style="display:none;clear:left;">
      </ul>

    </div>
  </div>
 </div>

 <script src="js/lodash.js"></script>
 <script src="js/moment.min.js"></script>
 <script src="js/jquery.min.js"></script>
 <script src='js/fullcalendar.js'></script>
 <script src='js/gcal.js'></script>
<script type="text/javascript">
var MG = {};
MG.groups = [];
MG.groupedEvents = {};
MG.dateRange = "";
MG.holidays = [];

function changeView(viewId) {
  $('.events-view').hide();
  $('#events-' + viewId).show();

  $('.events-link').removeClass('active');
  $('#events-' + viewId + '-link').addClass('active');
}

//https://codepen.io/KryptoniteDove/post/load-json-file-locally-using-pure-javascript
function loadJSON(filename, async, callback)
{
    var xobj = new XMLHttpRequest();
    xobj.overrideMimeType("application/json");
    xobj.open('GET', 'data/' + filename + '.json', async);
    xobj.onreadystatechange = function ()
    {
        if (xobj.readyState == 4 && xobj.status == "200")
        {
            // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
            callback(xobj.responseText);
        }
    };
    xobj.send(null);
}

function getGroups() {
    loadJSON("usergroups", false, function(response) {
        // Parse JSON string into object
        MG.groups = JSON.parse(response);
    });
}

function getHolidays()
{
    loadJSON("holidays", true, function (response)
    {
        var holidays = JSON.parse(response);
        var beginDate = getBeginDate();

        for (var i = 0; i < holidays.length; i++)
        {
            var holidayDate = getHolidayDate(holidays[i], beginDate);
            MG.holidays.push({
                name: holidays[i].name,
                date: holidayDate
            });
        }
    });
}

function getHolidayDate(holiday, beginDate)
{
    var holidayDate;
    var month = holiday.month - 1;
    var lastMonth = new Date().getMonth() - 1;
    var year = beginDate.getFullYear() + (month >= lastMonth ? 0 : 1);

    if (holiday.weekDay == undefined)
    {
        holidayDate = new Date(year, month, holiday.monthDay);
    }
    else
    {
        holidayDate = getDateByWeekDay(year, month, holiday.week, holiday.weekDay);
    }

    return holidayDate;
}

function renderEvents() {
  $('#events-list').empty();
  $('#events-table tbody').empty();

  var allEvents = [];
  $.each(MG.groupedEvents, function(groupId, events) {
    allEvents = allEvents.concat(MG.groupedEvents[groupId]);
  });

  // Sort events by time
  allEvents.sort(function(a, b) {
    return a.time - b.time;
  });

  // Add to table

  $.each(allEvents, function(index, event)
  {
    var dateTime = moment(event.time).format('YYYY-MM-DD, ddd, h:mma');
    var eventStr = event.event_url == ""
            ? event.name
            : '<a href="' + event.event_url + '">' + event.name + '</a>';
    var groupStr = event.group.urlname == ""
            ? event.group.name
            : '<a href="http://meetup.com/' + event.group.urlname + '">' + event.group.name + '</a>';
    // add to table
    var $eventRow = $('<tr><td>' + dateTime + '<td>' + eventStr + '<td>' + groupStr);
    $eventRow.addClass('group-' + event.group.urlname);
    $('#events-table tbody').append($eventRow);

    var $eventItem = $('<li></li>');
    $eventItem.append(dateTime + ': ' + eventStr + ' (' + groupStr + ')');
    $('#events-list').append($eventItem);
  });

  $('#events-calendar').fullCalendar('refetchEvents');
}

function renderGroups() {
  $('#groups-table tbody').empty();

  var allGroups = MG.groups;

  // Sort alphabetically
  allGroups.sort(compare);

  $.each(allGroups, function(index, group) {
    var groupStr = group.nameInMeetupURL.length > 0
            ? '<a href="http://meetup.com/' + group.nameInMeetupURL + '">' + group.name + '</a>'
            : group.name;
    var $groupRow = $('<tr>').addClass('group-' + group.nameInMeetupURL);
    $groupRow.append('<td>' + groupStr);

      var eventCount = MG.groupedEvents[group.name] == undefined ? 0 : MG.groupedEvents[group.name].length;

      var badgeClass = (eventCount > 0) ? 'badge badge-success' : 'badge';
      $groupRow.append('<td><span class="' + badgeClass + '">' + (eventCount > 0 ? eventCount : "loading") + '</span>');

    $('#groups-table tbody').append($groupRow);
  });

  if (allGroups.length > 0) {
    $('#groups-table').show();
  }
}

function compare(a, b) {
    return a.name < b.name ? -1 : a.name > b.name ? 1 : 0;
}

function getBeginDate()
{
    var beginDate = new Date(); //first day of last month
    beginDate.setMonth(beginDate.getMonth() - 1);
    beginDate.setDate(1);
    return beginDate;
}

function getEndDate(beginDate)
{
    var endDate = new Date(beginDate); //a year later
    endDate.setMonth(endDate.getMonth() + 12);
    endDate.setDate(endDate.getDate() - 1);
    return endDate;
}

function getDateRange() {
    var beginDate = getBeginDate();
    var endDate = getEndDate(beginDate);

    MG.dateRange = beginDate.getTime() + "," + endDate.getTime();
}

function createEvents(group)
{
    MG.groupedEvents[group.name] = MG.groupedEvents[group.name] || [];

    //create events for 12 months, starting with last month
    for (var i = -1; i <= 10; i++)
    {
        var asOfDate = new Date();
        asOfDate.setMonth(asOfDate.getMonth() + i);

        for (var meetingIndex = 0; meetingIndex < group.regularMeetings.length; meetingIndex++)
        {
            var meetupForCurrentMonth = createScheduledMeetup(group, group.regularMeetings[meetingIndex],
                    asOfDate.getFullYear(), asOfDate.getMonth());
            MG.groupedEvents[group.name].push(meetupForCurrentMonth);
        }
    }
}

function getUpcomingEvents(group) {
    getGroupEventsByStatus(group, "upcoming");
}

function getPastEvents(group) {
    getGroupEventsByStatus(group, "past");
}

function removeScheduledEvents(events, group, status)
{
    var months = _.uniq(events.map(function (event)
    {
        return new Date(event.time).getMonth();
    }));

    for (var i = 0; i < months.length; i++)
    {
        MG.groupedEvents[group.name] = MG.groupedEvents[group.name].filter(function (event)
        {
            return !(new Date(event.time).getMonth() == months[i]
            && (status == "upcoming" && event.time > new Date())
            || (status == "past" && event.time < new Date()));
        });
    }
}

function getGroupEventsByStatus(group, status) {
    if (group.nameInMeetupURL.length > 0)
    {
        var meetupParams = {
            'group_urlname': group.nameInMeetupURL ,
            'status': status,
            'time': MG.dateRange
        };
        var meetupUrl = 'https://api.meetup.com/2/events.json?' + $.param(meetupParams);
        var proxyUrl = 'https://crossorigin.me/' + meetupUrl;

        $.getJSON(proxyUrl, function (data)
        {
            if (data)
            {
                removeScheduledEvents(data.results, group, status);
                MG.groupedEvents[group.name].push.apply(MG.groupedEvents[group.name], data.results);
                renderGroups();
                renderEvents();
            }
        });
    }
}

function createScheduledMeetup(group, regularMeeting, year, month) {
    var scheduledTime = getScheduledTime(regularMeeting, year, month);

    return {
        name: regularMeeting.name.length > 0 ? regularMeeting.name : group.name,
        time: scheduledTime,
        event_url: "",
        group: {
            name: group.name,
            urlname: ""
        }
    };
}

function getScheduledTime(regularMeeting, year, month) {
    var scheduledTime = getDateByWeekDay(year, month, regularMeeting.week, regularMeeting.weekDay);
    scheduledTime.setHours(regularMeeting.hour);
    scheduledTime.setMinutes(regularMeeting.minute);

    return scheduledTime;
}

function getDateByWeekDay(year, month, week, weekDay) {
    var firstDayOfMonth = new Date(year, month, 1);

    var daysToAdd = weekDay - firstDayOfMonth.getDay();
    if (daysToAdd < 0)
    {
        daysToAdd += 7;
    }

    daysToAdd += 7 * (week - 1);

    var date = new Date(year, month, 1 + daysToAdd);

    //move to 4th week if there isn't a 5th week
    if (date.getMonth() != month)
    {
        date.setDate(date.getDate() - 7);
    }

    return date;
}

function refreshGroups() {
    getGroups();
    getHolidays();
    getDateRange();
    MG.groups.forEach(createEvents);
    renderGroups();
    renderEvents();
    MG.groups.forEach(getUpcomingEvents);
    MG.groups.forEach(getPastEvents);
}

function getDisplayName(event)
{
    var groupName;

    if (event.group.urlname == "")
    {
        groupName = event.group.name;
    }
    else
    {
        groupName = MG.groups
                .filter(function(meetupGroup)
                {
                    return meetupGroup["nameInMeetupURL"].toUpperCase() == event.group.urlname.toUpperCase();
                })
                .map(function(meetupGroup)
                {
                    return meetupGroup["name"];
                })[0];
    }

    if (event.name.includes("Tulsa") && !groupName.includes("Tulsa"))
    {
        groupName += " (Tulsa)";
    }

    //TODO: Add city to json data
    if (!groupName.includes("Tulsa") && !groupName.includes("OKC"))
    {
        groupName += " (OKC)";
    }

    return groupName;
}

$(document).ready(function(){

  $('#events-calendar').fullCalendar({
    editable: false,
    aspectRatio: 2,
    header: {
        left: 'prev,next',
        center: 'title',
        right: 'month,basicWeek,basicDay'
    },
    events: function(start, end, timezone, callback) {
      var allEvents = [];
      $.each(MG.groupedEvents, function(groupId, events) {
        $.each(events, function(index, event) {
          allEvents.push(
            {
              title: getDisplayName(event),
              start: new Date(event.time),
              url: event.event_url,
              color: (event.event_url == "" ? '#777777' : '#C92525')
            });
        });
      });

        for(var i = 0; i < MG.holidays.length; i++)
        {
            allEvents.push({
                title: MG.holidays[i].name,
                start: MG.holidays[i].date,
                allDay: true,
                url: "",
                color: '#3232A0'
            });
        }
      callback(allEvents);
    }
  });

  refreshGroups();

  $('#events-calendar').fullCalendar('refetchEvents');
});

</script>
</body>
</html>
